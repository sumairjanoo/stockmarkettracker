<!DOCTYPE html>
<html>
<head>
    <title>Stock Details</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <h1>Stock Market Tracker</h1>
    <form action="/stock" method="get">
        <input type="text" name="ticker" placeholder="Enter ticker symbol" required>
        <button type="submit">Search</button>
    </form>
    <h2>Stock Details</h2>
    {% if stock_data %}
        <ul>
            {% for key, value in stock_data.items() %}
                <li><strong>{{ key }}:</strong> {{ value }}</li>
            {% endfor %}
        </ul>
        <h3>Price History</h3>
        <label for="interval">Interval:</label>
        <select id="interval">
            <option value="7">1 Week</option>
            <option value="30" selected>1 Month</option>
            <option value="90">3 Months</option>
            <option value="180">6 Months</option>
            <option value="365">1 Year</option>
            <option value="custom">Custom</option>
        </select>
        <div id="custom-range" style="display:none;">
            Start: <input type="date" id="start-date">
            End: <input type="date" id="end-date">
            <button id="apply-range">Apply</button>
        </div>
        <div id="chart" style="width:100%;height:500px;"></div>
        <script>
            const ticker = "{{ ticker }}";
            function fetchAndPlot(start, end) {
                let url = `/api/price_history?ticker=${ticker}`;
                if (start) url += `&start=${start}`;
                if (end) url += `&end=${end}`;
                fetch(url)
                    .then(res => res.json())
                    .then(data => {
                        if (!data.length) {
                            document.getElementById('chart').innerHTML = "No data available.";
                            return;
                        }
                        const dates = data.map(d => d.date);
                        const closes = data.map(d => d.close);
                        Plotly.newPlot('chart', [{
                            x: dates,
                            y: closes,
                            type: 'scatter',
                            mode: 'lines+markers',
                            name: 'Close Price'
                        }], {
                            title: `${ticker} Price History`,
                            xaxis: { title: 'Date', type: 'date' },
                            yaxis: { title: 'Close Price' }
                        });
                    });
            }
            function getDateNDaysAgo(n) {
                const d = new Date();
                d.setDate(d.getDate() - n);
                return d.toISOString().slice(0,10);
            }
            document.getElementById('interval').addEventListener('change', function() {
                const val = this.value;
                if (val === 'custom') {
                    document.getElementById('custom-range').style.display = '';
                } else {
                    document.getElementById('custom-range').style.display = 'none';
                    const start = getDateNDaysAgo(parseInt(val));
                    const end = new Date().toISOString().slice(0,10);
                    fetchAndPlot(start, end);
                }
            });
            document.getElementById('apply-range').addEventListener('click', function(e) {
                e.preventDefault();
                const start = document.getElementById('start-date').value;
                const end = document.getElementById('end-date').value;
                fetchAndPlot(start, end);
            });
            // Initial plot: 1 Month
            fetchAndPlot(getDateNDaysAgo(30), new Date().toISOString().slice(0,10));
        </script>
        <h3>Related News</h3>
        <ul>
        {% for item in news %}
            <li>
                <a href="{{ item.url }}">{{ item.title }}</a> ({{ item.published_at }})
                <p>{{ item.summary }}</p>
            </li>
        {% endfor %}
        </ul>
    {% else %}
        <p>No data found for this ticker.</p>
    {% endif %}
    <a href="/">Back to search</a>
</body>
</html>